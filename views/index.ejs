<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/styles.css">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
<div class="container">
    <div class="left-side">
        <h2>Folder Viewer</h2>
        <ul id="file-list">
            <!-- File list will be populated here -->
        </ul>
    </div>
    <div class="right-side">
        <h2>Chat UI</h2>
        <div class="notice ai">Please note that the AI does not retain the memory of previous messages.</div>
        <div class="chat-history" id="chat-history">
            <!-- Chat history will be displayed here -->
        </div>
        <div class="chat-input-container">
            <textarea id="chat-input" placeholder="Type your message"></textarea>
            <button id="send-button">Send</button>
        </div>
    </div>
</div>

<script type="module">
    // Fetch and display the list of files in the folder
    fetch('/listFiles')
        .then((response) => response.json())
        .then((data) => {
            const fileList = document.getElementById('file-list');
            data.forEach((file) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${file.name} (${file.extension})`;
                fileList.appendChild(listItem);
            });
        });
</script>

<script type="module">
    const wsUrl = '<%= wsUrl %>';

    function fetchChatHistory() {
        fetch('/chat')
            .then((response) => response.json())
            .then((data) => {
                const chatHistory = document.getElementById('chat-history');
                chatHistory.innerHTML = data
                    .map((message) => {
                        const role = message.startsWith('You:') ? 'you' : 'ai';
                        return `<div class="chat-message ${role}">${message}</div>`;
                    })
                    .join('');

                chatHistory.scrollTop = chatHistory.scrollHeight;
            });
    }

    // Function to send a new message
    function sendChatMessage(message) {
        fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message }),
        }).then(() => {
            // After sending, add the message to the chat history immediately
            // addMessageToChat(message);
        });
    }

    // Function to add a new message to the chat history
    function addMessageToChat(message) {
        const chatHistory = document.getElementById('chat-history');
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');

        // Check if the message starts with 'You:' or 'AI:' to apply appropriate classes
        if (message.startsWith('You:')) {
            messageElement.classList.add('you');
        }
        if (message.startsWith('AI:')) {
            messageElement.classList.add('ai');
        }

        // Use innerHTML to insert HTML content
        messageElement.innerHTML = message;

        // Append the message element to the chat history
        chatHistory.appendChild(messageElement);

        // Automatically scroll down to the bottom
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Get elements from the DOM
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        const ws = new WebSocket(wsUrl);

        ws.onmessage = (event) => {
            const message = event.data;
            addMessageToChat(message);
        };

        // Listen for the "Send" button click event
        sendButton.addEventListener('click', () => {
            const messageText = chatInput.value;
            if (messageText) {
                sendChatMessage(messageText);
                chatInput.value = '';
            }
        });

        // Listen for the "Enter" key press in the textarea
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevents a new line in the textarea
                sendButton.click();
            }
        });

        // Fetch and display chat history when the page loads
        fetchChatHistory();
    });
</script>
</body>
</html>
